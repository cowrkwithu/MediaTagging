# 시스템 설계서

**프로젝트명:** MediaTagging
**버전:** v20260127
**작성일:** 2026-01-27

---

## 1. 개요

본 문서는 동영상 및 사진 AI 태깅 및 검색 웹 애플리케이션의 시스템 설계를 정의한다.

---

## 2. 시스템 아키텍처

### 2.1 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                         Client (Browser)                         │
│                      Next.js 13 Frontend                         │
└─────────────────────────────┬───────────────────────────────────┘
                              │ HTTP/HTTPS
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Backend Server                            │
│                       Python / FastAPI                           │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │ Video Upload │  │ Image Upload │  │   Search API         │   │
│  │    Module    │  │    Module    │  │     Module           │   │
│  └──────────────┘  └──────────────┘  └──────────────────────┘   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │ Scene Split  │  │  Tagging     │  │ External API Handler │   │
│  │    Module    │  │   Module     │  │  (Google Nanobana)   │   │
│  └──────────────┘  └──────────────┘  └──────────────────────┘   │
│  ┌──────────────┐  ┌──────────────┐                             │
│  │Image Tagging │  │   Export     │                             │
│  │    Module    │  │   Module     │                             │
│  └──────────────┘  └──────────────┘                             │
└─────────────────────────────┬───────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│    Database      │ │   File Storage   │ │   AI Service     │
│   PostgreSQL     │ │     Local        │ │  Ollama (Local)  │
└──────────────────┘ └──────────────────┘ └──────────────────┘
```

### 2.2 계층 구조

| 계층 | 역할 | 기술 |
|------|------|------|
| Presentation | 사용자 인터페이스 | Next.js 13 (App Router) |
| Application | 비즈니스 로직 | Python / FastAPI |
| Data | 데이터 저장 및 관리 | PostgreSQL, File Storage |
| External | 외부 서비스 연동 | Google Nanobana API, Ollama |

---

## 3. 기술 스택

### 3.1 Frontend

| 구분 | 기술 | 비고 |
|------|------|------|
| Framework | Next.js 13 | App Router 사용 |
| Language | TypeScript | 타입 안정성 확보 |
| Styling | Tailwind CSS | 유틸리티 기반 CSS |
| State Management | TanStack Query | 서버 상태 관리 (React Query) |
| Video Player | ReactPlayer | 동영상 재생 |
| HTTP Client | Axios | API 통신 |
| Icons | Lucide React | 아이콘 라이브러리 |

### 3.2 Backend

| 구분 | 기술 | 비고 |
|------|------|------|
| Framework | FastAPI | 비동기 처리, OpenAPI 자동 문서화 |
| Language | Python 3.11+ | AI/ML 생태계 활용 |
| ORM | SQLAlchemy | 데이터베이스 매핑 |
| Migration | Alembic | 스키마 마이그레이션 |
| Video Processing | FFmpeg | 영상 분할, 인코딩, 썸네일 추출 |
| Scene Detection | PySceneDetect | 장면 전환 감지 |
| Image Processing | Pillow | 이미지 처리, 썸네일 생성 |

### 3.3 Database

| 구분 | 기술 | 비고 |
|------|------|------|
| RDBMS | PostgreSQL | 메타데이터 저장 |
| Container | Docker | docker-compose로 실행 |

### 3.4 AI/ML

| 구분 | 기술 | 비고 |
|------|------|------|
| LLM Runtime | Ollama | 로컬 LLM 실행 |
| Vision Model | gemma3:27b | 이미지/프레임 분석, 요약, 태그 생성 |
| Timeout | 180초 | 비전 처리용 |

### 3.5 Infrastructure

| 구분 | 기술 | 비고 |
|------|------|------|
| Container | Docker | PostgreSQL 컨테이너화 |
| File Storage | Local Storage | /storage 디렉토리 |

---

## 4. 데이터베이스 설계

### 4.1 ERD (Entity Relationship Diagram)

```
┌─────────────────────┐       ┌─────────────────────┐
│       videos        │       │       scenes        │
├─────────────────────┤       ├─────────────────────┤
│ id (PK)             │───┐   │ id (PK)             │
│ filename            │   │   │ video_id (FK)       │──┐
│ title               │   └──▶│ start_time          │  │
│ summary             │       │ end_time            │  │
│ user_notes          │       │ thumbnail_path      │  │
│ file_path           │       │ clip_path           │  │
│ duration            │       │ created_at          │  │
│ file_size           │       └─────────────────────┘  │
│ status              │                                │
│ created_at          │       ┌─────────────────────┐  │
│ updated_at          │       │     scene_tags      │  │
└─────────────────────┘       ├─────────────────────┤  │
          │                   │ scene_id (FK, PK)   │◀─┘
          │                   │ tag_id (FK, PK)     │──┐
          ▼                   │ created_at          │  │
┌─────────────────────┐       └─────────────────────┘  │
│    video_tags       │                                │
├─────────────────────┤       ┌─────────────────────┐  │
│ video_id (FK, PK)   │       │        tags         │  │
│ tag_id (FK, PK)     │       ├─────────────────────┤  │
│ confidence          │       │ id (PK)             │◀─┴─┐
│ created_at          │       │ name (UNIQUE)       │    │
└─────────────────────┘       │ created_at          │    │
                              └─────────────────────┘    │
                                                         │
┌─────────────────────┐       ┌─────────────────────┐    │
│       images        │       │    image_tags       │    │
├─────────────────────┤       ├─────────────────────┤    │
│ id (PK)             │───┐   │ image_id (FK, PK)   │    │
│ filename            │   └──▶│ tag_id (FK, PK)     │────┘
│ title               │       │ created_at          │
│ description         │       └─────────────────────┘
│ user_notes          │
│ file_path           │
│ thumbnail_path      │
│ width               │
│ height              │
│ file_size           │
│ status              │
│ created_at          │
│ updated_at          │
└─────────────────────┘
```

### 4.2 테이블 정의

#### videos (동영상)

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| id | UUID | PK | 고유 식별자 |
| filename | VARCHAR(255) | NOT NULL | 원본 파일명 |
| title | VARCHAR(500) | | 사용자 입력 제목 |
| summary | TEXT | | AI 생성 요약 |
| user_notes | TEXT | | 사용자 입력 기록 (#태그 포함) |
| file_path | VARCHAR(1000) | NOT NULL | 저장 경로 |
| duration | INTEGER | | 영상 길이 (초) |
| file_size | BIGINT | | 파일 크기 (bytes) |
| status | VARCHAR(50) | NOT NULL | 처리 상태 |
| created_at | TIMESTAMP | NOT NULL | 생성일시 |
| updated_at | TIMESTAMP | NOT NULL | 수정일시 |

**status 값:**
- `uploaded`: 업로드 완료
- `processing`: 처리 중
- `tagged`: 태깅 완료
- `error`: 오류 발생

#### images (사진)

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| id | UUID | PK | 고유 식별자 |
| filename | VARCHAR(255) | NOT NULL | 원본 파일명 |
| title | VARCHAR(500) | | 사용자 입력 제목 |
| description | TEXT | | AI 생성 설명 |
| user_notes | TEXT | | 사용자 입력 기록 (#태그 포함) |
| file_path | VARCHAR(1000) | NOT NULL | 저장 경로 |
| thumbnail_path | VARCHAR(1000) | | 썸네일 경로 |
| width | INTEGER | | 이미지 너비 (px) |
| height | INTEGER | | 이미지 높이 (px) |
| file_size | BIGINT | | 파일 크기 (bytes) |
| status | VARCHAR(50) | NOT NULL | 처리 상태 |
| created_at | TIMESTAMP | NOT NULL | 생성일시 |
| updated_at | TIMESTAMP | NOT NULL | 수정일시 |

#### scenes (장면)

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| id | UUID | PK | 고유 식별자 |
| video_id | UUID | FK | 영상 ID |
| start_time | FLOAT | NOT NULL | 시작 시간 (초) |
| end_time | FLOAT | NOT NULL | 종료 시간 (초) |
| thumbnail_path | VARCHAR(1000) | | 썸네일 경로 |
| clip_path | VARCHAR(1000) | | 분할 영상 경로 |
| created_at | TIMESTAMP | NOT NULL | 생성일시 |

#### tags (태그)

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| id | UUID | PK | 고유 식별자 |
| name | VARCHAR(100) | UNIQUE, NOT NULL | 태그명 |
| created_at | TIMESTAMP | NOT NULL | 생성일시 |

#### video_tags (영상-태그 연결)

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| video_id | UUID | FK, PK | 영상 ID |
| tag_id | UUID | FK, PK | 태그 ID |
| confidence | FLOAT | | 신뢰도 (1.0 = 사용자 정의) |
| created_at | TIMESTAMP | NOT NULL | 생성일시 |

#### scene_tags (장면-태그 연결)

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| scene_id | UUID | FK, PK | 장면 ID |
| tag_id | UUID | FK, PK | 태그 ID |
| created_at | TIMESTAMP | NOT NULL | 생성일시 |

#### image_tags (사진-태그 연결)

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| image_id | UUID | FK, PK | 사진 ID |
| tag_id | UUID | FK, PK | 태그 ID |
| created_at | TIMESTAMP | NOT NULL | 생성일시 |

---

## 5. API 설계

### 5.1 REST API 엔드포인트

#### 동영상 관리 (/api/videos)

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | /upload | 동영상 업로드 |
| GET | / | 동영상 목록 조회 |
| GET | /{id} | 동영상 상세 조회 |
| PUT | /{id} | 동영상 메타데이터 수정 |
| DELETE | /{id} | 동영상 삭제 |
| POST | /{id}/tagging/start | 태깅 작업 시작 |
| GET | /{id}/tagging/status | 태깅 작업 상태 조회 |
| GET | /{id}/scenes | 장면 목록 조회 |
| GET | /{id}/stream | 동영상 스트리밍 (Range 지원) |

#### 사진 관리 (/api/images)

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | /upload | 사진 업로드 |
| GET | / | 사진 목록 조회 |
| GET | /{id} | 사진 상세 조회 |
| PUT | /{id} | 사진 메타데이터 수정 |
| DELETE | /{id} | 사진 삭제 |
| POST | /{id}/tagging/start | 태깅 작업 시작 |
| GET | /{id}/tagging/status | 태깅 작업 상태 조회 |
| GET | /{id}/file | 원본 사진 다운로드 |
| GET | /{id}/thumbnail | 썸네일 다운로드 |

#### 장면 관리 (/api/scenes)

| Method | Endpoint | 설명 |
|--------|----------|------|
| GET | /{id} | 장면 상세 조회 |
| GET | /{id}/download | 장면 영상 다운로드 |
| GET | /{id}/thumbnail | 장면 썸네일 다운로드 |
| POST | /export | 장면 병합 내보내기 |
| GET | /export/{filename}/download | 병합된 영상 다운로드 |

#### 검색 (/api/search)

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | / | 키워드 검색 (AND/OR/NOT) |
| GET | /tags | 태그 목록 조회 |

#### 외부 API 연동 (/api/external)

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | /nanobana/request | Nanobana API 요청 |
| GET | /nanobana/status/{id} | 요청 상태 조회 |

### 5.2 검색 쿼리 문법

```json
{
  "query": {
    "and": ["태그1", "태그2"],
    "or": ["태그3", "태그4"],
    "not": ["태그5"]
  },
  "target": ["videos", "scenes", "images"],
  "page": 1,
  "limit": 20
}
```

**검색 예시:**

| 검색 의도 | 쿼리 |
|----------|------|
| "고양이"와 "귀여운" 모두 포함 | `{"and": ["고양이", "귀여운"]}` |
| "고양이" 또는 "강아지" 포함 | `{"or": ["고양이", "강아지"]}` |
| "고양이" 포함, "싸움" 제외 | `{"and": ["고양이"], "not": ["싸움"]}` |

**검색 로직 우선순위:** AND > OR > NOT

---

## 6. 모듈 설계

### 6.1 Backend 모듈 구조

```
backend/
├── app/
│   ├── main.py                 # FastAPI 앱 진입점
│   ├── config.py               # 설정 관리
│   ├── api/
│   │   └── routes/
│   │       ├── videos.py       # 동영상 API
│   │       ├── images.py       # 사진 API
│   │       ├── scenes.py       # 장면 API
│   │       ├── search.py       # 검색 API
│   │       └── external.py     # 외부 API
│   ├── services/
│   │   ├── tagging_service.py      # 동영상 태깅 로직
│   │   └── image_tagging_service.py # 사진 태깅 로직
│   ├── models/
│   │   ├── database.py         # DB 연결
│   │   ├── video.py            # 동영상 모델
│   │   ├── image.py            # 사진 모델
│   │   ├── scene.py            # 장면 모델
│   │   └── tag.py              # 태그 모델
│   ├── schemas/
│   │   ├── video.py            # 동영상 스키마
│   │   ├── image.py            # 사진 스키마
│   │   ├── scene.py            # 장면 스키마
│   │   └── search.py           # 검색 스키마
│   └── utils/
│       ├── video_processor.py  # FFmpeg 래퍼
│       ├── scene_detector.py   # 장면 감지
│       └── ollama_client.py    # Ollama 클라이언트
├── alembic/                    # DB 마이그레이션
└── requirements.txt
```

### 6.2 Frontend 모듈 구조

```
frontend/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── page.tsx            # 홈 페이지
│   │   ├── layout.tsx          # 기본 레이아웃
│   │   ├── providers.tsx       # TanStack Query Provider
│   │   ├── upload/page.tsx     # 파일 업로드 페이지
│   │   ├── videos/
│   │   │   ├── page.tsx        # 동영상 목록
│   │   │   └── [id]/page.tsx   # 동영상 상세
│   │   ├── images/
│   │   │   ├── page.tsx        # 사진 목록
│   │   │   └── [id]/page.tsx   # 사진 상세
│   │   └── search/page.tsx     # 검색 페이지
│   ├── components/
│   │   ├── Navbar.tsx          # 네비게이션 바
│   │   ├── VideoPlayer.tsx     # 비디오 플레이어
│   │   ├── SceneTimeline.tsx   # 장면 타임라인
│   │   ├── ProcessingStatus.tsx # 처리 상태 표시
│   │   ├── Toast.tsx           # 알림 토스트
│   │   └── ErrorBoundary.tsx   # 에러 바운더리
│   ├── hooks/
│   │   └── useTaggingStatus.ts # 태깅 상태 폴링
│   ├── lib/
│   │   ├── api.ts              # API 클라이언트 (Axios)
│   │   └── utils.ts            # 유틸리티 함수
│   └── types/
│       └── index.ts            # TypeScript 타입 정의
├── public/
├── package.json
├── next.config.js
└── tailwind.config.ts
```

---

## 7. 처리 흐름

### 7.1 동영상 업로드 및 태깅 흐름

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Upload  │────▶│  Store   │────▶│ Extract  │────▶│   Save   │
│  Video   │     │  File    │     │ Duration │     │ Metadata │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
                                       │
                                       ▼ (사용자 요청 시)
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  status  │◀────│ Generate │◀────│ Aggregate│◀────│ Generate │
│ =tagged  │     │ Video    │     │ Scene    │     │ Scene    │
└──────────┘     │ Tags     │     │ Tags     │     │ Tags     │
                 └──────────┘     └──────────┘     └──────────┘
                                       ▲
                 ┌──────────┐     ┌──────────┐     ┌──────────┐
                 │ Generate │────▶│  Detect  │────▶│  Create  │
                 │ Summary  │     │  Scenes  │     │Thumbnails│
                 └──────────┘     └──────────┘     └──────────┘
```

### 7.2 사진 업로드 및 태깅 흐름

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Upload  │────▶│  Store   │────▶│ Generate │────▶│   Save   │
│  Image   │     │  File    │     │Thumbnail │     │ Metadata │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
                                       │
                                       ▼ (사용자 요청 시)
┌──────────┐     ┌──────────┐     ┌──────────┐
│  status  │◀────│ Generate │◀────│ Generate │
│ =tagged  │     │  Tags    │     │Description│
└──────────┘     │(5-15개)  │     │ (AI)     │
                 └──────────┘     └──────────┘
```

### 7.3 검색 흐름

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Parse   │────▶│  Build   │────▶│ Execute  │────▶│  Return  │
│  Query   │     │   SQL    │     │  Query   │     │ Results  │
│(AND/OR/  │     │(JOIN/IN/ │     │          │     │(videos,  │
│  NOT)    │     │ NOT IN)  │     │          │     │ images,  │
└──────────┘     └──────────┘     └──────────┘     │ scenes)  │
                                                   └──────────┘
```

---

## 8. 파일 저장 구조

```
/storage/
├── videos/{uuid}.{ext}              # 원본 동영상 파일
├── images/{uuid}.{ext}              # 원본 사진 파일
├── thumbnails/
│   ├── images/{uuid}_thumb.jpg      # 사진 썸네일
│   └── {video_uuid}/
│       ├── summary_frame_{0,1,2}.jpg  # 요약용 프레임
│       └── scene_{scene_uuid}.jpg     # 장면 썸네일
├── clips/{video_uuid}/
│   └── scene_{scene_uuid}.mp4       # 추출된 장면 클립
└── exports/
    ├── merged_{uuid}.mp4            # 병합된 비디오
    └── concat_{uuid}.txt            # FFmpeg concat 메타파일
```

---

## 9. 외부 시스템 연동

### 9.1 Ollama (로컬 LLM)

| 항목 | 내용 |
|------|------|
| 용도 | 영상/사진 요약, 설명, 태그 생성 |
| 프로토콜 | HTTP REST API |
| 기본 엔드포인트 | http://localhost:11434 |
| 사용 모델 | gemma3:27b |
| 타임아웃 | 180초 (비전 처리) |

### 9.2 Google Nanobana API

| 항목 | 내용 |
|------|------|
| 용도 | 동영상 제작 요청 |
| 프로토콜 | HTTP REST API |
| 인증 | API Key |
| 연동 방식 | 비동기 요청/콜백 |

---

## 10. 보안 고려사항

| 항목 | 대응 방안 |
|------|----------|
| 파일 업로드 | 파일 타입 검증, 확장자 whitelist |
| API 인증 | 현재 미구현 (추후 JWT 고려) |
| SQL Injection | SQLAlchemy ORM 사용 |
| XSS | 입력값 이스케이프 |
| CORS | Next.js 프록시 사용 |

---

## 11. 주요 설정값

```python
# config.py
database_url: postgresql://postgres:postgres@localhost:5432/editVideoTagging
ollama_base_url: http://localhost:11434
ollama_model: gemma3:27b
storage_path: /home/john/mediaTagging/storage

# 장면 감지 설정
scene_threshold: 20.0          # 낮을수록 민감
scene_min_length: 10           # 최소 프레임 수
scene_frames_per_scene: 3      # 분석용 프레임 수
```

---

## 12. 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| v20260126151726 | 2026-01-26 | - | 최초 작성 |
| v20260127 | 2026-01-27 | - | 사진 관리 기능 추가 (images 테이블, API, 프론트엔드), image_tagging_service 추가 |
